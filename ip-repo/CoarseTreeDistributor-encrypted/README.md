# Coarse Tree Distributor
This is a Vivado 2017.3 Project, used to generate a unique Coarse-Timestamp and split it to all the Channels of the TDC. Using the Coarse Tree Distributor (CTD) as Coarse-Timestamp generator, the inner Coarse-Counter inside the Coarse Extension Core (CEC) is not implemented.
This module is requested to create a Coarse-Counter with *BIT_COARSE* dimension initialized at *CTD_COARSE_CNT_INIT*. The Coarse-Counter is split into *NUMBER_OF_OUTPUT* branches with *BIT_COARSE* as bit-dimension by means of a parametric tree-distributor. The tree-distributor is configurable as the maximum fan-out (*MAX_OUTPUT_ENGINE_PIPELINE*) that each engine (splitter) called *Engine_CTD* has.
From the total outputs of the CTD (*NUMBER_OF_OUTPUT*) and the *MAX_OUTPUT_ENGINE_PIPELINE* that each splitter has, the *step_CTD_pipeline_init* function, inside *LocalPackage_CTD*, computes the number of stages (*NUM_STAGE*) and its bit dimensions (*NUM_IN_STEP*,*BIT_LNG*,*NUM_OUT_ENGINE*) required by each single pipeline stage *Step_CTD* that are instantiated in series inside *CoarseTreeDistributorWrapper_CTD*.
Each single stage *Step_CTD* hosts the proper number of *Engine_CTD* with the required fan-out set by *MAX_OUTPUT_ENGINE_PIPELINE*. The number of *Engine_CTD* inside each *Step_CTD* is automatically computed by *step_CTD_pipeline_init* and stored into *NUM_OUT_ENGINE*.


<br/>  The figure shows the implementation where:
  - *BIT_COARSE = 8*,
  - *NUMBER_OF_OUTPUT = 5*,
  - *MAX_OUTPUT_ENGINE_PIPELINE_0 = 3*,
  - *MAX_OUTPUT_ENGINE_PIPELINE_1 = 2*

So, the *CoarseTreeDistributorWrapper_CTD* is composed of *NUM_STAGE = 2* *Step_CTD*  where:
  - *Step_CTD[0]* has *NUM_IN_STEP = 1*, so one (First) *Engine_CTD* with:
    - *BIT_LNG = BIT_COARSE = 8*,
    - *NUM_OUT_ENGINE = MAX_OUTPUT_ENGINE_PIPELINE_0 = 3*

    - *Step_CTD[1]* has *NUM_IN_STEP = 3*, so 3 (number of output of previous *Step_CTD* ) *Engine_CTD* with :
      - *BIT_LNG = BIT_COARSE = 8*,
      - *NUM_OUT_ENGINE = MAX_OUTPUT_ENGINE_PIPELINE_1 = 2*

We see just 5 outputs because the figure shows the case of  *NUMBER_OF_OUTPUT = 5*


![CTD Image](doc/img/CTD_structure.svg)  

The splitting of the Coarse Counter is managed by the *Engine_CTD* splitter. We can see a splitting by-2 Engine in the following figure:

![engine Image](doc/img/Engine.png)  

The *Engine_CTD* splits the input in more outputs and buffer each output by means of a Flip-Flop.

![flip_flop Image](doc/img/Flip_Flop.png)  


# IP-Core
Assign the Coarse Counter, generated by the *CoarseTreeDistributorWrapper_CTD*, to the outputs.

![IP-Core Image](doc/img/CoarseTreeDistributor_IP-Core.png)  

## Generic

 - **CTD_COARSE_CNT_INIT**: Initialization value of the Coarse Counter (External to Channel TDC), *NATURAL* type.
 - **BIT_COARSE**: Bit Dimension of the Coarse Counter, *POSITIVE* type *RANGE  1  TO  32*.

 - **NUMBER_OF_OUTPUT**: Number of outputs at the end of the Tree of the *CoarseTreeDistributor*, *POSITIVE* type *RANGE  2  TO  16*.

 - **MAX_OUTPUT_ENGINE_PIPELINE_0**: Select the max number of outputs for the first stage of the pipeline, *POSITIVE* type *RANGE  1  TO  8*.
 - **MAX_OUTPUT_ENGINE_PIPELINE_1**: Select the max number of outputs for the second stage of the pipeline, *POSITIVE* type *RANGE  1  TO  8*.
 - **MAX_OUTPUT_ENGINE_PIPELINE_2**: Select the max number of outputs for the third stage of the pipeline, *POSITIVE* type *RANGE  1  TO  8*.
 - **MAX_OUTPUT_ENGINE_PIPELINE_3**: Select the max number of outputs for the fourth stage of the pipeline, *POSITIVE* type *RANGE  1  TO  8*.

![Generic Image](doc/img/CoarseTreeDistributor_Generic.png)  

## Port

 - **reset**: Asynchronous system reset active high (if '1' goto reset state).

 - **clk**: Sampling clock at clk_TDC.

 - **CoarseCounter_CTD_i**: Value of the External Coarse Counter with i in [0; 15], *STD_LOGIC_VECTOR(BIT_COARSE-1 downto 0)* type. We have as many *CoarseCounter_CTD* as the maximum *NUMBER_OF_OUTPUT*, *16*.


# Sources
We can find in "hdl/" the following module directory:

  - **CoarseTreeDistributor**: *CoarseTreeDistributor* Wrapper for creating an IP-Core in Vivado.
  - **CoarseTreeDistributorWrapper_CTD**: Series of *Step_CTD* to split all the inputs coming from the Coarse Counter.
  - **Step_CTD**: Union of different *Engine_CTD* that work in parallel.
  - **Engine_CTD**: Configurable engine (splitter) that buffer the input and split it into outputs.
  - **LocalPackage_CTD**: Functions, Procedures and Types required by the *CTD* modules.


# Simulation
We can find in "src/" the following module directory, where it is possible to modify all the parameters.

  - **tb_CoarseTreeDistributorWrapper_CTD**: HDL simulation of *CoarseTreeDistributorWrapper_CTD*
  - **tb_CoarseTreeDistributorWrapper_CTD_behav**: Waveform of *tb_CoarseTreeDistributorWrapper_CTD*


![wave Image](doc/img/wave.png)  



# TODO
1) Python Cosimulation
